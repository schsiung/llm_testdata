if("undefined"==typeof sipCredentials)throw new Error("Sorry! No SIP credentials found");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({audio:!0},(function(){$("#status").html("Dail a Number!"),$("#callButton").prop("disabled",!1)}),(function(){$("#status").html("<div style='font-size: 14px;' class='alert alert-danger'>No microphone found! Please connect your mic and reload!</div>"),$("#callButton").prop("disabled",!0)}));var remoteAudio=new window.Audio;remoteAudio.autoplay=!0,remoteAudio.crossOrigin="anonymous";var session,socket=new JsSIP.WebSocketInterface(sipCredentials.socket),configuration={sockets:[socket],uri:sipCredentials.uri,password:sipCredentials.pass,username:sipCredentials.user,register:!0},callOptions={mediaConstraints:{audio:!0,video:!1}},caller="",callerDisplay="",hideNumbers=["*78","*79","*76"],phone=new JsSIP.UA(configuration);function addCallLog({caller:e="",direction:t="",duration:n="",status:a=""}=""){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addCallLog",type:"post",data:{caller:e,direction:t,duration:n,status:a,feedback:$("#feedbackArea").val(),reviewer:$("#feedbackReviewer").val()},success:function(e,t){}})}function showCallerDetails(e){$(".caseList input[type=search]").val(e),$(".caseList input[type=search]").trigger("keyup"),$(".personList input[type=search]").val(e),$(".personList input[type=search]").trigger("keyup"),$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=getCallerDetails",type:"post",data:{caller:e},success:function(t,n){if("success"==n){var a=JSON.parse(t);if(0!==Object.keys(a.details).length){session&&"incoming"===session.direction&&(void 0!==a.details.type?BMS.fn.desktopNotify(`${a.details.name} (${e}) is calling...`,full_website_address+"/assets/images/call.png",`${a.details.type}, ${a.details.designation}`):BMS.fn.desktopNotify(`${e} is calling...`,full_website_address+"/assets/images/call.png","Click Here to open the dashboard")),$(".callerInfo > tbody > tr:nth-child(1) > td:nth-child(2)").html(a.details.name),$(".callerInfo > tbody > tr:nth-child(2) > td:nth-child(2)").html(a.details.type),$(".callerInfo > tbody > tr:nth-child(3) > td:nth-child(2)").html(a.details.designation),$(".callerInfo > tbody > tr:nth-child(4) > td:nth-child(2)").html(a.details.address);var l="There is no call";""!==a.agentName&&(l=`By <b>${a.agentName}</b>, at ${a.lastCallTime}; ${a.call_status} (${a.totalCallCount} total call)`),$(".callerInfo > tbody > tr:nth-child(5) > td:nth-child(2)").html(l)}else{$(".callerInfo > tbody > tr:nth-child(1) > td:nth-child(2)").html("No data found in database"),$(".callerInfo > tbody > tr:nth-child(2) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(3) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(4) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(5) > td:nth-child(2)").html("");l="There is no call";""!==a.agentName&&(l=`By <b>${a.agentName}</b>, at ${a.lastCallTime}; ${a.call_status} (${a.totalCallCount} total call)`),$(".callerInfo > tbody > tr:nth-child(5) > td:nth-child(2)").html(l),session&&"incoming"===session.direction&&BMS.fn.desktopNotify(`${e} is calling...`,full_website_address+"/assets/images/call.png","Click Here to open the dashboard")}}}})}phone.on("newRTCSession",(function(e){var t=e.session;if(session)return addCallLog({caller:t.remote_identity.uri.user,direction:t.direction,duration:0,status:"Missed"}),t.terminate(),!1;var n=function(){session=null,$("#muteCall, #holdCall").show(),$("#unholdCall, #unmuteCall").hide()};caller=(session=t).remote_identity.uri.user,callerDisplay=session.remote_identity.display_name,session.on("ended",(function(){jQuery.inArray(caller,hideNumbers)<0&&(addCallLog({caller:caller,direction:session.direction,duration:Math.floor((session.end_time.getTime()-session.start_time.getTime())/1e3),status:"Answered"}),$("#callDailer").show(),$("#callReceiver").hide(),BMS.fn.pause(),$("#callButton").show(),$("#hangButton").hide(),BMS.fn.stopTimer(window.timer),$("#status").html("Dail a number!"),$(".caseList input[type=search]").val(""),$(".caseList input[type=search]").trigger("keyup"),$("#timer").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(500).fadeIn(500,(function(){$("#timer").html("00:00:00"),$("#timer").hide()}))),n()})),session.on("failed",(function(e){$("#callDailer").show(),$("#callReceiver").hide(),BMS.fn.pause(),$("#callButton").show(),$("#hangButton").hide(),"incoming"===session.direction?"local"===e.originator?$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){$("#status").html("Call rejected!"),addCallLog({caller:caller,direction:"incoming",duration:0,status:"Rejected"})})):($("#status").html(`Missed call from ${callerDisplay}!`),addCallLog({caller:caller,direction:"incoming",duration:0,status:"Missed"})):"local"===e.originator?$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){$("#status").html("Dail a number!"),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Unreachable"})})):$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){"SIP Failure Code"===e.cause?($("#status").html("The number is not answered!"),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Not Answered"})):($("#status").html("The number is busy!"),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Busy"}))})),n()})),session.on("hold",(function(e){"remote"===e.originator?$("#status").html(`${caller} is hold you.`):$("#status").html(`${caller} is on hold.`)})),session.on("muted",(function(e){$("#status").html("Call is muted.")})),session.on("unmuted",(function(e){$("#status").html(`${caller} is connected.`)})),session.on("unhold",(function(){$("#status").html(`${caller} is connected.`)})),session.on("accepted",(function(){jQuery.inArray(caller,hideNumbers)<0&&($("#timer").show(),window.timer=BMS.fn.startTimer(),$("#status").html(`${caller} is connected.`),$("#csSmsSendTo").val(caller),$("#feedbackCaller").val(caller))})),session.on("confirmed",(function(){var e=session.connection.getLocalStreams()[0],t=session.connection.createDTMFSender(e.getAudioTracks()[0]);session.sendDTMF=function(e){t.insertDTMF(e)}})),session.on("peerconnection",(e=>{const t=e.peerconnection;t.onaddstream=function(e){remoteAudio.srcObject=e.stream,remoteAudio.play()};var n=new MediaStream;t.getReceivers().forEach((function(e){n.addTrack(e.track)}))})),"incoming"===session.direction?(BMS.fn.play("incoming_call",!0),$("#status").html(`${callerDisplay} is calling...`),$("#callReceiver").show(),$("#timer").hide(),$("#callDailer").hide(),showCallerDetails(caller)):session.connection.addEventListener("addstream",(function(e){BMS.fn.pause(),remoteAudio.srcObject=e.stream}))})),phone.start(),$(document).on("click","#callButton",(function(){var e=$("#callNumber").val();session=phone.call(e,callOptions),$("#status").html(`Call is being send to ${e}...`),$("#callButton").hide(),$("#hangButton").show(),showCallerDetails(caller),$("#feedbackArea, #feedbackReviewer").val(""),$(document).off("change","#feedbackArea, #feedbackReviewer")})),$(document).on("click","#hangButton",(function(){session.terminate()})),$(window).on("beforeunload",(function(){session.terminate()})),$(document).on("click","#muteCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.mute(),$("#muteCall, #unmuteCall").toggle()})),$(document).on("click","#unmuteCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.unmute(),$("#muteCall, #unmuteCall").toggle()})),$(document).on("click","#holdCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.hold(),$("#holdCall, #unholdCall").toggle()})),$(document).on("click","#unholdCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.unhold(),$("#holdCall, #unholdCall").toggle()})),$(document).on("click","#transferCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call to transfer.");var e={};$.each(extentionNumbers,(function(t,n){e[n.extention]=n.name})),Swal.fire({title:"Please select the extension",input:"select",inputOptions:e,showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> Transfer Call',closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Destination number..."}).then((e=>{void 0!==e.value&&(session.refer(e.value),session.terminate())}))})),$(document).on("click","#enableDND",(function(){phone.call("*78",callOptions),localStorage.setItem("dnd","enable"),$("#enableDND, #disableDND, .dndAlert").toggle()})),$(document).on("click","#disableDND",(function(){phone.call("*79",callOptions),localStorage.setItem("dnd","disable"),$("#enableDND, #disableDND, .dndAlert").toggle()})),$(document).on("click","#callReceiveButton",(function(){session.answer(callOptions),$("#timer").show(),BMS.fn.pause()})),$(document).on("click","#IncomingCallHangButton",(function(){session.terminate(),BMS.fn.pause()})),$(document).scroll((function(e){$(window).scrollTop()>20?($("#customerSupport").css("box-shadow","rgba(0, 0, 0, 0.07) 0px 1px 1px, rgba(0, 0, 0, 0.07) 0px 2px 2px, rgba(0, 0, 0, 0.07) 0px 4px 4px, rgba(0, 0, 0, 0.07) 0px 8px 8px, rgba(0, 0, 0, 0.07) 0px 16px 16px"),$("#customerSupport section").slideUp("fast",(function(){$(this).hide()}))):($("#customerSupport").css("box-shadow","none"),$("#customerSupport section").slideDown("fast",(function(){$(this).show()})))})),$(document).on("click","#csSendSMS",(function(){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=sendSMS",type:"post",data:{number:$("#csSmsSendTo").val(),text:$("#csSmsText").val()},success:function(e,t){"1"===e?(BMS.fn.alertSuccess("SMS successfully sent.",!1),$("#csSmsText").val("")):BMS.fn.alertError("SMS faild to send.")}})})),$(document).on("click",".addToSMSBox tr",(function(){var e="";$("td",this).slice(3,6).each((function(){e+=$(this).text()+"\n"})),$("#csSmsText").val((function(){return this.value+e}))})),$(document).on("click","#addNewCase",(function(){var e=full_website_address+"/xhr/?module=customer-support&page=newCase&num=";$("#modalDefaultMdm").modal("show").find(".modal-content").load(e+encodeURI(caller))})),$(document).on("click","#saveFeedback",(function(){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=updateCallFeedback",type:"post",data:{caller:$("#feedbackCaller").val(),feedback:$("#feedbackArea").val()},success:function(e,t){e.includes("success")?(BMS.fn.alertSuccess($(e).text(),!1),$("#feedbackCaller").val(""),$("#feedbackArea").val("")):BMS.fn.alertError($(e).text())}})})),$(document).on("click",".quickFeedback > ul > li:not(:last-child)",(function(){$("#feedbackArea").val($("#feedbackArea").val()+$(this).text()+"\n")})),$(document).on("click",".quickFeedback > ul > li:last-child",(function(){Swal.fire({title:"Enter new feedback",input:"textarea",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Write feedback here"}).then((e=>{void 0!==e.value&&($.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addNewNote",type:"post",data:{note:e.value,type:"feedback"}}),$(".quickFeedback > ul > li:last-child").before(`<li style='cursor:pointer;'>${e.value}</li>`))}))})),$(document).on("click",".userNote > ul > li:not(:last-child)",(function(){var e=this;$("#csSmsText").val((function(){return this.value+$(e).text()+"\n"}))})),$(document).on("click",".userNote > ul > li:last-child",(function(){Swal.fire({title:"Enter note here",input:"textarea",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Write note here"}).then((e=>{void 0!==e.value&&($.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addNewNote",type:"post",data:{note:e.value,type:"note"}}),$(".userNote > ul > li:last-child").before(`<li style='cursor:pointer;'>${e.value}</li>`))}))})),$(document).on("keypress","#callNumber",(function(e){if("Enter"===e.key){var t=$(this).val();t.length<2?alert("Please enter a valid number to continue"):showCallerDetails(t)}})),JsSIP.debug.disable("JsSIP:*");